<html>
    <head>
        <title>Map Age</title>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script src="changes.js"></script>

        <style>
            body{
                margin:0;
                color: #333;
                font-style: normal;
                font-family: "Myriad Set Pro","Lucida Grande","Helvetica Neue","Helvetica","Arial","Verdana","sans-serif";
            }
            #map { height: 100%; }
            #question{
                position: fixed;
                bottom:0;
                width:100vw;
                height:30vh;
                margin: 0 auto;
                padding: 20px;

                text-align:center;
                background-color:lightgray;
                font-size: 2.5em;
            }
            .button{
                font-size:1em;
            }
            #done{
              display:none;
              background-color:#CD5555;
              position:fixed;
              top:0;
              left:0;
              height:100vh;
              width:100vw;
            }
            #map-age-message{
              font-size:2em;
            }
        </style>
    </head>
    <body>
        <div id="done">
          <div id="map-age-message"></div>
          <button>Reset</button>
        </div>
        <div id="map"></div>
        <div id="question">
            <p>What country is this?</p>
            <button id='newCountry' class="button"></button>
            <button id='oldCountry' class="button"></button>
        </div>
        <script>
//initialize map
            var map = L.map('map').setView([0,0], 2);
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            var currentMarker;

            var newestMap = 0;
            var oldestMap = 10000; 
            changes.reduce(function(prev,cur,index,array){
                newestMap = newestMap < cur.dateofchange ? cur.dateofchange : newestMap;  
                oldestMap = oldestMap > cur.dateofchange ? cur.dateofchange : oldestMap;
            });
            var currentSpot = changes[Math.floor(changes.length/2)]; //setting an inital point
            updateMap(currentSpot);

            $("#newCountry").click(function(){ 
                var mapIsOlder = false; 
                updatePoint(mapIsOlder);
            });
            $("#oldCountry").click(function(){
                var mapIsOlder = true; 
                updatePoint(true);
            });

            function updatePoint(mapIsOlder){
                //check if we're done!
                if(foundMapAge()){
                  //we're done!
                  $("#map-age-message").html("Your map was made between "+oldestMap+" and "+newestMap+"!");
                  $("#done").show();
                }
                else{
                  //we're not done
                  if(mapIsOlder){//then the youngest it can be is the current map age.
                      newestMap = currentSpot.dateofchange;
                  }
                  else{//then the oldest it can be is the current map age.
                      oldestMap = currentSpot.dateofchange;
                  }
                  currentSpot = getNewChangePoint();

                  //updateMap
                  updateMap(currentSpot);
                  
                }                
            }

            function updateMap(spot){
              $("#newCountry").html(spot.newname);
              $("#oldCountry").html(spot.formername);
              map.panTo([spot.lat, spot.long]);
              if(currentMarker){
                  map.removeLayer(currentMarker);
              }
              currentMarker = new L.marker([spot.lat, spot.long]).addTo(map);
            }

            function foundMapAge(){
              if( changes.filter(function(e){ if(e.dateofchange < newestMap && e.dateofchange > oldestMap){return e}}).length == 0){
                return true;
              }
              return false;
            }

            function getNewChangePoint(){
              var availablePoints = changes.filter(function(e){ if(e.dateofchange < newestMap && e.dateofchange > oldestMap){return e}});
              return availablePoints[Math.floor(availablePoints.length/2)];
            }
        </script>
    </body>
</html>
